
var OF,$,jQuery;jQuery.fn.touch=function(func){if(func){OF.touch.bindHandlers(this,func);}else{OF.touch(this);}
return $(this);};jQuery.fn.pretouch=function(){var elems=$(this);elems.addClass('touched');$.defer(function(){elems.removeClass('touched');});return elems;};OF.touch=function(element){if(OF.touch.disabled){return;}
element=$(element);var data=element.data();if(data&&data.event){var args=data.event.split(',');OF.GA.event.apply(OF,args);}
element.trigger('touch');if(data&&data.href){var url=element.data().href;if(!url.match(/\.json/)){if(url.match(/\?/)){url=url.replace(/\?/,'.json?');}else{url=url+'.json';}}
var options={};if(element.attr('title')){options.title=element.attr('title');}
OF.push(url,options);}else if(data&&data.action){OF.action(data.action);}else if(data&&data.controller){OF.pushController(data.controller);}
OF.touch.disabled=true;setTimeout(function(){OF.touch.disabled=false;},500);};OF.touch.element=null;OF.touch.x=null;OF.touch.y=null;OF.touch.isScrolling=false;OF.touch.bindHandlers=function(elems,onTouch){if(elems){var ctx=OF.topPage().eventContext;var sel=typeof(elems)==='string'?elems:elems.selector;elems=$(sel,ctx);}else{elems=$('*[data-href], *[data-event], *[data-action], *[data-controller]');}
var touchHandler=function(e){e.stopPropagation();onTouch.apply(this,arguments);};if(onTouch){elems.die('touch').unbind('touch');elems.live('touch',touchHandler).bind('touch',touchHandler);}
if(OF.isDevice){elems.die('touchstart').die('touchend').unbind('touchstart').unbind('touched');elems.live('touchstart',OF.touch.touchstart).live('touchend',OF.touch.touchend).bind('touchstart',OF.touch.touchstart).bind('touchend',OF.touch.touchend);}else{elems.die('mousedown').die('mouseup').die('click');elems.live('mousedown',function(){$(this).addClass('touched');}).live('mouseup',function(){$(this).removeClass('touched');}).live('click',function(){OF.touch(this);});}};OF.touch.touchstart=function(event){var $this=$(this);var ofTouch=OF.touch;var ofTouchEl=ofTouch.element;if(ofTouchEl&&$(ofTouchEl).parents($this).length>0){return;}
else if(ofTouchEl||ofTouch.isScrolling){ofTouch.cancel();return;}
event.stopPropagation();event=event.originalEvent;var aTouch=(event.targetTouches&&event.targetTouches[0])||{screenX:0,screenY:0};ofTouch.element=this;ofTouch.x=aTouch.screenX;ofTouch.y=aTouch.screenY;if(OF.page.scrolling){this.onTouchTimer=setTimeout(function(){$this.addClass('touched');},50);}else{$this.addClass('touched');}};OF.touch.touchend=function(event){var touchMethod=OF.touch;var touchEl=touchMethod.element;event.stopPropagation();event=event.originalEvent;if(touchEl){if(touchEl===this){touchMethod(this);}
touchMethod.cancel();}};OF.touch.cancel=function(){var ofTouchEl=OF.touch.element;if(ofTouchEl){var $ofTouchEl=$(ofTouchEl);clearTimeout(ofTouchEl.onTouchTimer);$ofTouchEl.removeClass('touched');}
OF.touch.element=null;OF.touch.x=null;OF.touch.y=null;};$(document).ready(function(){document.ontouchmove=function(event){var ofTouch=OF.touch,ofPage=OF.page;var limit=ofPage.scrolling?5:25;var aTouch=event.targetTouches[0];var x=Math.abs(aTouch.screenX-ofTouch.x);var y=Math.abs(aTouch.screenY-ofTouch.y);if(ofTouch.element&&x>limit||y>limit){ofTouch.cancel();}
if(!ofPage.scrolling){event.preventDefault();}};});